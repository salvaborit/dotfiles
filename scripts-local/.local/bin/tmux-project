#!/usr/bin/env bash
# Tmux project session automation
# Auto-creates tmux sessions for project directories with configured layout

set -euo pipefail

# Default project directories to search
PROJECT_DIRS=(
  "$HOME/prj"
)

# Find all project directories (max depth 2)
find_projects() {
  for dir in "${PROJECT_DIRS[@]}"; do
    if [ -d "$dir" ]; then
      find "$dir" -maxdepth 2 -type d -name ".git" -exec dirname {} \; 2>/dev/null
    fi
  done | sort -u
}

# Create session name from project path
session_name_from_path() {
  local project_path="$1"
  basename "$project_path" | tr '.' '_'
}

# Create project sessions (3 separate sessions)
create_project_sessions() {
  local project_path="$1"
  local base_name="$2"

  # Session names for each terminal
  local editor_session="${base_name}-editor"
  local terminal_session="${base_name}-terminal"
  local git_session="${base_name}-git"

  # Check if sessions already exist
  if tmux has-session -t "$editor_session" 2>/dev/null; then
    echo "Sessions for '$base_name' already exist"
    return 1
  fi

  # Create 3 separate sessions, each with 1 window

  # Session 1: Editor (nvim)
  tmux new-session -d -s "$editor_session" -c "$project_path"
  tmux rename-window -t "$editor_session:1" "editor"
  tmux send-keys -t "$editor_session:1" "nvim" C-m

  # Session 2: Git (lazygit)
  tmux new-session -d -s "$git_session" -c "$project_path"
  tmux rename-window -t "$git_session:1" "git"
  if command -v lazygit &>/dev/null; then
    tmux send-keys -t "$git_session:1" "lazygit" C-m
  fi

  # Session 3: Terminal (bash)
  tmux new-session -d -s "$terminal_session" -c "$project_path"
  tmux rename-window -t "$terminal_session:1" "terminal"

  echo "Created sessions for project: $project_path"
}

# Main logic
main() {
  # Check if tmux is installed
  if ! command -v tmux &>/dev/null; then
    echo "Error: tmux is not installed"
    exit 1
  fi

  # If no argument, show project picker
  if [ $# -eq 0 ]; then
    projects=$(find_projects)

    if [ -z "$projects" ]; then
      echo "No projects found in: ${PROJECT_DIRS[*]}"
      exit 1
    fi

    # Use rofi to select project
    selected=$(echo "$projects" | rofi -dmenu -p "Projects")

    if [ -z "$selected" ]; then
      exit 0
    fi
  else
    # Use provided directory
    selected="$1"

    if [ ! -d "$selected" ]; then
      echo "Error: Directory not found: $selected"
      exit 1
    fi
  fi

  # Create sessions
  base_name=$(session_name_from_path "$selected")
  editor_session="${base_name}-editor"
  terminal_session="${base_name}-terminal"
  git_session="${base_name}-git"

  if create_project_sessions "$selected" "$base_name"; then
    # Sessions created - launch separate terminals in order: nvim, lazygit, bash
    if [ -n "${TMUX:-}" ]; then
      # Inside tmux, just switch to editor session
      tmux switch-client -t "$editor_session"
    else
      # Launch 3 separate Alacritty terminals in order
      alacritty --config-file ~/.config/alacritty/alacritty-nvim.toml -e tmux attach-session -t "$editor_session" &
      sleep 0.1
      alacritty -e tmux attach-session -t "$git_session" &
      sleep 0.1
      alacritty -e tmux attach-session -t "$terminal_session" &
    fi
  else
    # Sessions exist - reattach to them in same order
    if [ -n "${TMUX:-}" ]; then
      tmux switch-client -t "$editor_session"
    else
      # Reattach to existing sessions
      alacritty --config-file ~/.config/alacritty/alacritty-nvim.toml -e tmux attach-session -t "$editor_session" &
      sleep 0.1
      alacritty -e tmux attach-session -t "$git_session" &
      sleep 0.1
      alacritty -e tmux attach-session -t "$terminal_session" &
    fi
  fi
}

main "$@"
