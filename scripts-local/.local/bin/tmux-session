#!/usr/bin/env bash
# Tmux session manager using walker
# Creates, attaches, or switches tmux sessions

set -euo pipefail

# Get list of existing sessions
get_sessions() {
  if tmux ls 2>/dev/null; then
    return 0
  else
    return 1
  fi
}

# Create session list for walker
create_menu() {
  echo "ðŸ“ New session"

  if get_sessions >/dev/null 2>&1; then
    get_sessions | while IFS=: read -r session rest; do
      # Check if session is attached
      attached=$(echo "$rest" | grep -o "attached" || echo "")
      if [ -n "$attached" ]; then
        echo "âœ“ $session (attached)"
      else
        echo "â—‹ $session"
      fi
    done
  fi
}

# Main logic
main() {
  # Check if tmux is installed
  if ! command -v tmux &>/dev/null; then
    notify-send "Tmux" "Tmux is not installed" -u critical
    exit 1
  fi

  # If inside tmux, use built-in session switcher
  if [ -n "${TMUX:-}" ]; then
    tmux choose-tree -Zs
    exit 0
  fi

  # Use rofi to select session
  choice=$(create_menu | rofi -dmenu -p "Select a session")

  if [ -z "$choice" ]; then
    exit 0
  fi

  # Handle new session
  if [[ "$choice" == "ðŸ“ New session" ]]; then
    session_name=$(echo "" | rofi -dmenu -p "New session name")
    if [ -z "$session_name" ]; then
      exit 0
    fi

    # Create and attach to new session in alacritty
    alacritty -e tmux new-session -s "$session_name" &
    exit 0
  fi

  # Extract session name (remove status indicators)
  session_name=$(echo "$choice" | sed -E 's/^(âœ“|â—‹) //' | awk '{print $1}')

  # Get number of windows in session and launch separate terminal for each
  num_windows=$(tmux list-windows -t "$session_name" 2>/dev/null | wc -l)

  if [ "$num_windows" -eq 0 ]; then
    # Fallback: single window
    alacritty -e tmux attach-session -t "$session_name" &
  else
    # Launch separate terminal for each window
    for ((i = 1; i <= num_windows; i++)); do
      tmux-window-terminal "$session_name" "$i"
      sleep 0.1
    done
  fi
}

main "$@"
